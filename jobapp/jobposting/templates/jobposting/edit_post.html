{% extends "base.html" %}
{% block title %}Edit Job Post | JobBoard{% endblock %}
{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<h1>Edit Job Post</h1>
<form method="post">
    {% csrf_token %}
    {{form.errors}}
    
    <input type="hidden" name="latitude" id="id_latitude" value="{{ form.latitude.value|default_if_none:'' }}">
    <input type="hidden" name="longitude" id="id_longitude" value="{{ form.longitude.value|default_if_none:'' }}">

    <div class="row">
        <div class="col-md-6">
            <ul>
                <li>
                    <label for="id_title">Title:</label>
                    <input type="text" name="title" id="id_title" value="{{ form.title.value|default_if_none:'' }}" class="form-control">
                </li>
                <li>
                    <label for="id_skills">Skills:</label>
                    <input type="text" name="skills" id="id_skills" value="{{ form.skills.value|default_if_none:'' }}" class="form-control">
                </li>
                <li>
                    <label for="id_city">City:</label>
                    <input type="text" name="city" id="id_city" value="{{ form.city.value|default_if_none:'' }}" class="form-control">
                </li>
                <li>
                    <label for="id_state">State:</label>
                    <input type="text" name="state" id="id_state" value="{{ form.state.value|default_if_none:'' }}" class="form-control">
                </li>
                <li>
                    <label for="id_country">Country:</label>
                    <input type="text" name="country" id="id_country" value="{{ form.country.value|default_if_none:'' }}" class="form-control">
                </li>
                <li>
                    <label for="id_salary">Salary:</label>
                    <input type="text" name="salary" id="id_salary" value="{{ form.salary.value|default_if_none:'' }}" class="form-control">
                </li>
                <li>
                    <label for="id_remote_type">Remote/On-site:</label>
                    <select name="remote_type" id="id_remote_type" class="form-control">
                        {% for value, label in form.remote_type.field.choices %}
                            <option value="{{ value }}" {% if form.remote_type.value == value %}selected{% endif %}>{{ label }}</option>
                        {% endfor %}
                    </select>
                </li>
                <li>
                    <label for="id_visa_sponsorship">Visa Sponsorship:</label>
                    <input type="checkbox" name="visa_sponsorship" id="id_visa_sponsorship" {% if form.visa_sponsorship.value %}checked{% endif %}>
                </li>
                <li>
                    <label for="id_description">Description:</label>
                    <textarea name="description" id="id_description" class="form-control">{{ form.description.value|default_if_none:'' }}</textarea>
                </li>
                <li>
                    <label for="id_qualifications">Qualifications:</label>
                    <textarea name="qualifications" id="id_qualifications" class="form-control">{{ form.qualifications.value|default_if_none:'' }}</textarea>
                </li>
            </ul>
        </div>
        <div class="col-md-6">
             <label>Office Location:</label>
             <div id="map" style="height: 500px; width: 100%; border-radius: 5px; border: 1px solid #ccc;"></div>
             <p class="text-muted small">Drag marker to adjust location.</p>
        </div>
    </div>

    <button class="btn btn-primary" type="submit" name="save_exit">Save and Exit</button>
    <a href="{% url 'jobposting.viewpost' jobpost.id %}" class="btn btn-secondary">Cancel</a>
</form>

<script>
    // Initial Coordinates from server
    const initialLat = parseFloat("{{ form.latitude.value|default:0 }}");
    const initialLng = parseFloat("{{ form.longitude.value|default:0 }}");
    
    const hasLocation = (initialLat !== 0 || initialLng !== 0);
    
    // Default to US center if no location set
    const center = hasLocation ? [initialLat, initialLng] : [39.8283, -98.5795];
    const zoom = hasLocation ? 12 : 4;

    const map = L.map('map').setView(center, zoom);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Â© OpenStreetMap'
    }).addTo(map);

    const latInput = document.getElementById('id_latitude');
    const lngInput = document.getElementById('id_longitude');
    let marker = null;

    if (hasLocation) {
        marker = L.marker(center, {draggable: true}).addTo(map);
        marker.on('dragend', function(e) {
            const pos = e.target.getLatLng();
            latInput.value = pos.lat;
            lngInput.value = pos.lng;
        });
    }

    map.on('click', function(e) {
        const lat = e.latlng.lat;
        const lng = e.latlng.lng;

        if (marker) {
            marker.setLatLng(e.latlng);
        } else {
            marker = L.marker(e.latlng, {draggable: true}).addTo(map);
            marker.on('dragend', function(ev) {
                const pos = ev.target.getLatLng();
                latInput.value = pos.lat;
                lngInput.value = pos.lng;
            });
        }
        latInput.value = lat;
        lngInput.value = lng;
    });
</script>
{% endblock %}