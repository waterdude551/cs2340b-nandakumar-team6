{% extends 'base.html' %}
{% load static %}
{% block content %}

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
    /*MAP STYLES!*/
#map {
    height: 600px;
    width: 100%;
  }
  .filter-controls {
    padding: 15px;
    background: white;
    border-radius: 5px;
    margin-bottom: 15px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
  }
  .filter-controls label {
    margin-right: 10px;
    font-weight: bold;
  }
  .filter-controls input {
    padding: 5px 10px;
    border-radius: 4px;
    border: 1px solid #ccc;
    width: 100px;
  }
  .filter-controls button {
    padding: 5px 15px;
    border-radius: 4px;
    border: 1px solid #007bff;
    background-color: #007bff;
    color: white;
    cursor: pointer;
    margin-left: 10px;
  }
  .filter-controls button:hover {
    background-color: #0056b3;
  }
  #job-count {
    margin-left: 15px;
    color: #666;
  }
</style>
<div class="filter-controls">
  <label for="distance-input" class="text-dark">Show jobs within:</label>
  <input type="number" id="distance-input" placeholder="Miles" min="1" value="50">
  <span class="text-dark">miles</span>
  <button onclick="filterJobsByDistance()">Apply Filter</button>
  <button onclick="clearFilter()">Show All</button>
  <span id="job-count"></span>
</div>

<div id="map"></div>

<script id="jobs-data" type="application/json">
{{ jobs_json|safe }}
</script>

<script>
    const jobs = JSON.parse(document.getElementById('jobs-data').textContent);
    let userLocation = null;
    let allMarkers = [];
    
    // Initialize map with default location
    const map = L.map('map').setView([39.8283, -98.5795], 4);

    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 18,
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);

    // Calculate distance between two points (Haversine formula)
    function calculateDistance(lat1, lon1, lat2, lon2) {
        const R = 3959; // Earth's radius in miles
        const dLat = (lat2 - lat1) * Math.PI / 180;
        const dLon = (lon2 - lon1) * Math.PI / 180;
        const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
                  Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                  Math.sin(dLon/2) * Math.sin(dLon/2);
        const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
        return R * c;
    }

    // Filter jobs by distance
    function filterJobsByDistance() {
        const distanceInput = document.getElementById('distance-input').value;
        const maxDistance = parseFloat(distanceInput);
        
        if (!maxDistance || maxDistance <= 0) {
            alert('Please enter a valid distance');
            return;
        }

        if (!userLocation) {
            alert('Waiting for your location...');
            return;
        }

        let visibleCount = 0;

        allMarkers.forEach(markerData => {
            const distance = calculateDistance(
                userLocation.lat,
                userLocation.lon,
                markerData.job.latitude,
                markerData.job.longitude
            );
            
            if (distance <= maxDistance) {
                markerData.marker.addTo(map);
                visibleCount++;
            } else {
                map.removeLayer(markerData.marker);
            }
        });

        // Update job count
        document.getElementById('job-count').textContent = 
            `Showing ${visibleCount} of ${jobs.length} jobs within ${maxDistance} miles`;
    }

    // Clear filter and show all jobs
    function clearFilter() {
        allMarkers.forEach(markerData => {
            markerData.marker.addTo(map);
        });
        
        document.getElementById('job-count').textContent = 
            `Showing ${jobs.length} of ${jobs.length} jobs`;
        document.getElementById('distance-input').value = '';
    }

    // Get user location from IP and recenter map
    fetch('http://ip-api.com/json/')
        .then(response => response.json())
        .then(data => {
            if (data.lat && data.lon) {
                userLocation = { lat: data.lat, lon: data.lon };
                map.setView([data.lat, data.lon], 10);
                
                // Add user location marker
                L.marker([data.lat, data.lon], {
                    icon: L.icon({
                        iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
                        shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
                        iconSize: [25, 41],
                        iconAnchor: [12, 41],
                        popupAnchor: [1, -34],
                        shadowSize: [41, 41]
                    })
                }).addTo(map).bindPopup('Your Location');
            }
        })
        .catch(error => {
            console.log('Could not get user location:', error);
        });

    // Create markers for all jobs
    jobs.forEach(job => {
        const popupContent = '<strong>' + job.title + '</strong><br>' +
                           job.location + '<br>' +
                           (job.salary ? 'Salary: ' + job.salary + '<br>' : '') +
                           job.remote_type + '<br>' +
                           (job.skills ? 'Skills: ' + job.skills + '<br>' : '') +
                           '<a href="/jobposting/' + job.id + '/">View Details</a>'; //link should work now!
        
        const marker = L.marker([job.latitude, job.longitude])
            .bindPopup(popupContent);
        
        allMarkers.push({ marker: marker, job: job });
        marker.addTo(map);
    });

    // Update job count initially
    document.getElementById('job-count').textContent = 
        `Showing ${jobs.length} of ${jobs.length} jobs`;

    // Allow Enter key to trigger filter
    document.getElementById('distance-input').addEventListener('keypress', function(e) {
        if (e.key === 'Enter') {
            filterJobsByDistance();
        }
    });
</script>

{% endblock %}